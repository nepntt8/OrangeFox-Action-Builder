name: OrangeFox - Build

# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox
# https://github.com/azwhikaru for Recovery Builder Template
# And all Contributors in every repositories I used

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options:
        - 12.1
        - 11.0
      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/nepntt8/Makeit2android_device_samsung_m14x'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot
      TREBLE_ENABLED:
        description: 'Enable Treble Support (No Vendor Tree Required)'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    name: Build OFR by ${{ github.actor }}
    runs-on: ubuntu-22.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
              
    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24
      
    - name: Build Environment
      run: |
        sudo apt install aria2 -y
        git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
        cd scripts
        sudo bash setup/android_build_env.sh
      
    - name: Set-up Manifest
      if: inputs.MANIFEST_BRANCH == '11.0' || inputs.MANIFEST_BRANCH == '12.1'
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        git clone https://gitlab.com/OrangeFox/sync.git -b master
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

    - name: Clone Device Tree
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Apply Full Treble Support (No Vendor Tree Needed)
      if: inputs.TREBLE_ENABLED == 'true'
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}
        
        # Treble BoardConfig flags - Generic Treble support
        cat >> BoardConfig.mk << 'EOF'

        # ==================== Treble Support ====================
        BOARD_NEEDS_VENDORIMAGE := true
        TARGET_USES_PREBUILT_VENDOR_SEPOLICY := true
        PRODUCT_FULL_TREBLE_OVERRIDE := true
        PRODUCT_COMPATIBLE_PROPERTY_OVERRIDE := true
        TARGET_COPY_OUT_VENDOR := vendor
        TARGET_RECOVERY_FSTAB := device/samsung/m14x/recovery.fstab

        # VNDK Support
        BOARD_VNDK_VERSION := current
        PRODUCT_EXTRA_VNDK_VERSIONS := current 29 30 31

        # Treble properties
        BOARD_PROPERTY_OVERRIDES_SPLIT_ENABLED := true

        # SELinux for Treble
        BOARD_SEPOLICY_DIRS += device/samsung/m14x/sepolicy/treble
        SYSTEM_SEPOLICY_DIR += device/samsung/m14x/sepolicy/treble/private
        SYSTEM_EXT_PUBLIC_SEPOLICY_DIRS += device/samsung/m14x/sepolicy/treble/public

        # Treble Recovery
        TARGET_RECOVERS_WITH_TREBLE := true
        TARGET_RECOVERY_UI_LIB := librecovery_ui_treble
        TARGET_RECOVERY_PIXEL_FORMAT := "RGBX_8888"

        EOF

        # Update device.mk for Treble packages
        cat >> device.mk << 'EOF'

        # ==================== Treble Packages ====================
        PRODUCT_PACKAGES += \\
            android.hardware.boot@1.1-impl \\
            android.hardware.boot@1.1-impl.recovery \\
            android.hardware.boot@1.1-service \\
            android.hardware.health@2.1-impl \\
            android.hardware.health@2.1-impl.recovery \\
            android.hardware.health@2.1-service \\
            libion \\
            libmemtrack \\
            libprocessgroup \\

        # VNDK
        PRODUCT_EXTRA_VNDK_VERSIONS := current 29 30 31

        # Treble properties
        PRODUCT_SYSTEM_PROPERTIES += \\
            ro.treble.enabled=true \\
            ro.treble.tracing.enabled=true \\
            ro.vndk.lite=true \\
            ro.system.product.manufacturer=samsung \\
            ro.product.manufacturer=samsung \\
            ro.system.product.model=m14x \\
            ro.product.model=m14x

        EOF

        # Create treble recovery.fstab if missing
        if [ ! -f recovery.fstab ]; then
          cat > recovery.fstab << 'EOF'
        # Android fstab file.
        # The filesystem that contains the filesystem checker binary (filesystem checkers
        # are only run in the recovery environment).
        /dev/block/bootdevice/by-name/boot    /boot    emmc    defaults
        /dev/block/bootdevice/by-name/recovery /recovery emmc defaults
        /dev/block/bootdevice/by-name/system  /system  ext4    defaults
        /dev/block/bootdevice/by-name/vendor  /vendor  ext4    defaults
        /dev/block/bootdevice/by-name/product /product ext4    defaults
        /dev/block/bootdevice/by-name/system_ext /system_ext ext4 defaults
        /dev/block/bootdevice/by-name/odm     /odm     ext4    defaults
        EOF
        fi

    - name: Building OrangeFox
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        set +e
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        
        # Use appropriate lunch target based on Treble
        if [ "${{ inputs.TREBLE_ENABLED }}" == "true" ]; then
          echo "Building with Full Treble Support..."
          lunch twrp_${{ inputs.DEVICE_NAME }}-userdebug
        else
          echo "Building standard OrangeFox..."
          lunch twrp_${{ inputs.DEVICE_NAME }}-eng
        fi
        
        make clean && mka adbd ${{ inputs.BUILD_TARGET }}image

    - name: Set Release Properties
      run: |
        echo "BUILD_DATE=$(TZ=Asia/Manila date +%Y%m%d)" >> $GITHUB_ENV
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
        if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
          DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
        fi
        echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
        name: OrangeFox Recovery for ${{ inputs.DEVICE_NAME }} // ${{ env.BUILD_DATE }} ${{ inputs.TREBLE_ENABLED == 'true' && '(Full Treble)' || '' }}
        tag_name: ${{ github.run_id }}
        body: |
          ## OrangeFox Recovery Build - Unofficial
          
          **Build**: fox_${{ inputs.MANIFEST_BRANCH }}
          **Device**: [Device Tree/Branch](${{ env.DEVICE_TREE_URL }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          **Commit**: Most recent [commit](${{ env.DEVICE_TREE_URL }}/commit/${{ env.COMMIT_ID }}) during building.
          
          **Treble Support**: ${{ inputs.TREBLE_ENABLED == 'true' && '✅ Full Treble Enabled (GSI Compatible)' || '❌ Standard Build' }}
          
          **Features**:
          ${{ inputs.TREBLE_ENABLED == 'true' && format('- ✅ Project Treble Support
- ✅ GSI Compatibility
- ✅ VNDK Support
- ✅ Generic Vendor Handling' || '- Standard OrangeFox features') }}
