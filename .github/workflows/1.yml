name: OrangeFox - Build (GSI Supported)

# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox
# https://github.com/azwhikaru for Recovery Builder Template
# And all Contributors in every repositories I used

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options:
        - 12.1
        - 11.0
      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/nepntt8/Makeit2android_device_samsung_m14x'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot
      TREBLE_ENABLED:
        description: 'Enable Treble/GSI Support (No Vendor Tree Required)'
        required: false
        default: 'true'
        type: boolean
      GSI_SUPPORT:
        description: 'Full GSI Compatibility (Requires Treble)'
        required: false
        default: 'true'
        type: boolean

jobs:
  build:
    name: Build OFR by ${{ github.actor }} ${{ inputs.TREBLE_ENABLED == 'true' && '(GSI)' || '' }}
    runs-on: ubuntu-22.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
              
    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24
      
    - name: Build Environment
      run: |
        sudo apt install aria2 -y
        git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
        cd scripts
        sudo bash setup/android_build_env.sh
      
    - name: Set-up Manifest
      if: inputs.MANIFEST_BRANCH == '11.0' || inputs.MANIFEST_BRANCH == '12.1'
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        git clone https://gitlab.com/OrangeFox/sync.git -b master
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

    - name: Clone Device Tree
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Apply Full Treble + GSI Support
      if: inputs.TREBLE_ENABLED == 'true'
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}
        
        # ==================== Enhanced Treble + GSI BoardConfig ====================
        cat >> BoardConfig.mk << 'EOF'
        # ==================== Project Treble + GSI Support ====================
        BOARD_NEEDS_VENDORIMAGE := true
        TARGET_USES_PREBUILT_VENDOR_SEPOLICY := true
        PRODUCT_FULL_TREBLE_OVERRIDE := true
        PRODUCT_COMPATIBLE_PROPERTY_OVERRIDE := true
        TARGET_COPY_OUT_VENDOR := vendor
        TARGET_COPY_OUT_PRODUCT := product
        TARGET_COPY_OUT_SYSTEM_EXT := system_ext
        
        # GSI Compatibility
        BOARD_GSI_DANGLING_SYMLINKS := true
        BOARD_USES_METADATA_PARTITION := true
        
        # VNDK + HAL Support
        BOARD_VNDK_VERSION := current
        PRODUCT_EXTRA_VNDK_VERSIONS := current 29 30 31 32 33
        BOARD_VNDK_RUNTIME_DISABLE := false
        
        # Dynamic Partitions (Super Partition)
        BOARD_SUPER_PARTITION_SIZE := 9126805504
        BOARD_SUPER_FILE_SYSTEM := ext4
        BOARD_SUPER_DUP_SYSTEM_PARTITIONS_WITHOUT_REPLACEMENT := true
        BOARD_SUPER_USE_PREBUILT_FM := true
        
        # Treble Properties
        BOARD_PROPERTY_OVERRIDES_SPLIT_ENABLED := true
        TARGET_RECOVERY_FSTAB := device/${{ inputs.DEVICE_PATH }}/recovery.fstab
        
        # Enhanced SELinux for GSI
        BOARD_SEPOLICY_DIRS += device/${{ inputs.DEVICE_PATH }}/sepolicy/treble
        SYSTEM_SEPOLICY_DIR += device/${{ inputs.DEVICE_PATH }}/sepolicy/treble/private
        SYSTEM_EXT_PUBLIC_SEPOLICY_DIRS += device/${{ inputs.DEVICE_PATH }}/sepolicy/treble/public
        PRODUCT_PUBLIC_SEPOLICY_DIRS += device/${{ inputs.DEVICE_PATH }}/sepolicy/treble/public
        
        # GSI Recovery Support
        TARGET_RECOVERS_WITH_TREBLE := true
        TARGET_RECOVERY_UI_LIB := librecovery_ui_treble
        TARGET_RECOVERY_PIXEL_FORMAT := "RGBX_8888"
        BOARD_MOVE_RECOVERY_RESOURCES_TO_VENDOR_BOOT := true
        EOF

        # ==================== Enhanced device.mk for GSI ====================
        cat >> device.mk << 'EOF'
        # ==================== GSI + Treble Packages ====================
        PRODUCT_PACKAGES += \\
            android.hardware.boot@1.1-impl \\
            android.hardware.boot@1.1-impl.recovery \\
            android.hardware.boot@1.1-service \\
            android.hardware.health@2.1-impl \\
            android.hardware.health@2.1-impl.recovery \\
            android.hardware.health@2.1-service \\
            android.hardware.graphics.mapper@3.0-impl \\
            android.hardware.graphics.mapper@3.0-impl.recovery \\
            android.hardware.keymaster@4.1 \\
            libion \\
            libmemtrack \\
            libprocessgroup \\
            libgui_validation \\
            libgralloctypes

        # GSI Properties (Dynamic - Multiple types supported)
        PRODUCT_SYSTEM_PROPERTIES += \\
            ro.treble.enabled=true \\
            ro.treble.tracing.enabled=true \\
            ro.vndk.lite=true \\
            ro.vndk.lite.min=true \\
            ro.boot.vbmeta.avb_vts_profile=2 \\
            ro.system.product.manufacturer=samsung \\
            ro.product.manufacturer=samsung \\
            ro.system.product.model=${{ inputs.DEVICE_NAME }} \\
            ro.product.model=${{ inputs.DEVICE_NAME }} \\
            ro.treble.rootpixel=false \\
            persist.vendor.sys.modem_dups=1 \\
            ro.opengles.version=196610

        # Dynamic GSI Compatibility (supports A/B, A-only, VNDK variants)
        ifneq ($(filter true,$(TARGET_IS_VAB)),)
        PRODUCT_SYSTEM_PROPERTIES += \\
            ro.treble.vab=true
        endif
        EOF

        # ==================== GSI-Optimized recovery.fstab ====================
        cat > recovery.fstab << 'EOF'
        # Android fstab file (GSI Compatible)
        /dev/block/bootdevice/by-name/boot      /boot      emmc    defaults
        /dev/block/bootdevice/by-name/recovery  /recovery  emmc    defaults
        /dev/block/by-name/super                /super     auto    wait
        /dev/block/bootdevice/by-name/vendor    /vendor    ext4    defaults
        /dev/block/bootdevice/by-name/product   /product   ext4    defaults
        /dev/block/bootdevice/by-name/system_ext /system_ext ext4 defaults
        /dev/block/bootdevice/by-name/odm       /odm       ext4    defaults
        /dev/block/bootdevice/by-name/dtbo      /dtbo      emmc    defaults
        /dev/block/bootdevice/by-name/vbmeta    /vbmeta    emmc    defaults
        EOF

    - name: Building OrangeFox
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        set +e
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        
        if [ "${{ inputs.TREBLE_ENABLED }}" == "true" ]; then
          echo "üü¢ Building OrangeFox with Full GSI/Treble Support..."
          lunch twrp_${{ inputs.DEVICE_NAME }}-userdebug
        else
          echo "üîµ Building standard OrangeFox..."
          lunch twrp_${{ inputs.DEVICE_NAME }}-eng
        fi
        
        make clean && mka adbd ${{ inputs.BUILD_TARGET }}image

    - name: Set Release Properties
      run: |
        echo "BUILD_DATE=$(TZ=Asia/Manila date +%Y%m%d)" >> $GITHUB_ENV
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
        if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
          DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
        fi
        echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
        name: OrangeFox R${{ inputs.MANIFEST_BRANCH }} for ${{ inputs.DEVICE_NAME }} // ${{ env.BUILD_DATE }} ${{ inputs.TREBLE_ENABLED == 'true' && '(GSI/Treble)' || '' }}
        tag_name: ${{ github.run_id }}
        body: |
          # ü¶ä OrangeFox Recovery Build - Unofficial (GSI Ready)
          
          **üì± Device**: ${{ inputs.DEVICE_NAME }}
          **üõ†Ô∏è  Build**: fox_${{ inputs.MANIFEST_BRANCH }}
          **üåø Device Tree**: [${{ inputs.DEVICE_TREE_BRANCH }}](${{ env.DEVICE_TREE_URL }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          **üíæ Commit**: [Latest](${{ env.DEVICE_TREE_URL }}/commit/${{ env.COMMIT_ID }})
          **üìÖ Built**: ${{ env.BUILD_DATE }}
          
          ## üéØ GSI/Treble Status
          ${{ inputs.TREBLE_ENABLED == 'true' && '‚úÖ **FULL GSI SUPPORT** (Treble + Dynamic Compatibility)' || '‚ùå Standard Build' }}
          
          ${{ inputs.TREBLE_ENABLED == 'true' && inputs.GSI_SUPPORT == 'true' && '
          ### ‚úÖ **GSI Features Enabled**:
          - **Project Treble**: Full implementation
          - **Dynamic GSI Support**: A/B, A-only, VNDK variants
          - **Super Partition**: Native support
          - **VNDK**: current + 29/30/31/32/33
          - **Generic Vendor**: No vendor tree needed
          - **Enhanced recovery.fstab**: GSI-optimized
          - **SELinux**: Treble/GSI policies
          ' || '' }}
          
          ## üöÄ **Install Instructions**:
          1. Flash via `fastboot flash recovery OrangeFox.img`
          2. **For GSI**: Use **"Install ‚Üí Install Image ‚Üí Select GSI"**
          3. **GSI Types Supported**: A-only, A/B, VNDK, SAR, etc.
          
          **üí° Tip**: Enable **"Keep System Read-Only"** for stable GSI flashing!
          
          ---
          *Built with ‚ù§Ô∏è by ${{ github.actor }}*
