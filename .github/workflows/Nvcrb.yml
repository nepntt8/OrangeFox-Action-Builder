name: OrangeFox - Build

# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox  
# https://github.com/azwhikaru for Recovery Builder Template
# And all Contributors in every repositories I used

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/nepntt8/Makeit2android_device_samsung_m14x.git'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: [boot, recovery, vendorboot]

jobs:
  build:
    name: Build OFR NON-VANILLA+TREBLE by ${{ github.actor }}
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Display Inputs
      run: |
        echo "::group::User Environment Variables"
        echo "Branch: ${{ inputs.MANIFEST_BRANCH }}"
        echo "Device: ${{ inputs.DEVICE_NAME }}"
        echo "Target: ${{ inputs.BUILD_TARGET }}"
        echo "::endgroup::"

    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24

    - name: Build Environment
      run: |
        sudo apt update && sudo apt install aria2 -y
        rm -rf scripts
        git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
        cd scripts
        sudo bash setup/android_build_env.sh

    - name: Set-up Manifest
      if: contains(fromJSON('["11.0", "12.1"]'), inputs.MANIFEST_BRANCH)
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        git clone https://gitlab.com/OrangeFox/sync.git -b master
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

    - name: Clone Device Tree
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    # ðŸ”¥ DEVICE TREE VALIDATION
    - name: Validate Device Tree
      run: |
        echo "::group::ðŸ” DEVICE TREE VALIDATION"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}
        echo "ðŸ“ Required files check:"
        [[ -f BoardConfig.mk ]] && echo "âœ… BoardConfig.mk exists" || echo "âŒ BoardConfig.mk MISSING!"
        [[ -f AndroidProducts.mk ]] && echo "âœ… AndroidProducts.mk exists" || echo "âŒ AndroidProducts.mk MISSING!"
        [[ -f device.mk ]] && echo "âœ… device.mk exists" || echo "âŒ device.mk MISSING!"
        echo "ðŸ“‹ BoardConfig preview:"
        head -20 BoardConfig.mk || true
        echo "::endgroup::"

    # ðŸ”¥ 28 NON-VANILLA + TREBLE FLAGS (SAFER)
    - name: Inject NON-VANILLA+TREBLE Flags
      run: |
        BOARDCONFIG="${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk"
        [[ -f "$BOARDCONFIG" ]] || { echo "âŒ BoardConfig.mk not found!"; exit 1; }
        
        # Check if flags already exist (avoid duplicates)
        if ! grep -q "FOX_VANILLA_BUILD" "$BOARDCONFIG"; then
          echo "FOX_VANILLA_BUILD := 0" >> "$BOARDCONFIG"
        fi
        echo "OF_DISABLE_MIUI_SPECIFIC_FEATURES := 0" >> "$BOARDCONFIG"
        echo "OF_TREBLE_CHECK_ON_REBOOT := 1" >> "$BOARDCONFIG"
        echo "OF_SUPPORT_GSI_FLASHING := 1" >> "$BOARDCONFIG"
        echo "OF_KEEP_GSI_PARTIALLY_DECRYPTED := 1" >> "$BOARDCONFIG"
        echo "OF_GSI_MODE := 1" >> "$BOARDCONFIG"
        echo "OF_NO_TREBLE_COMPATIBILITY_CHECK := 0" >> "$BOARDCONFIG"
        echo "FOX_AVB := 1" >> "$BOARDCONFIG"
        echo "OF_PATCH_AVB20 := 1" >> "$BOARDCONFIG"
        echo "OF_USE_MAGISKBOOT := 1" >> "$BOARDCONFIG"
        echo "OF_USE_MAGISKBOOT_FOR_ALL_PATCHES := 1" >> "$BOARDCONFIG"
        echo "OF_DEFAULT_KEYMASTER_VERSION := 4.1" >> "$BOARDCONFIG"
        echo "FOX_USE_NANO_EDITOR := 1" >> "$BOARDCONFIG"
        echo "OF_USE_GREEN_LED := 1" >> "$BOARDCONFIG"
        echo "OF_FIX_7ZIP_ZIP := 1" >> "$BOARDCONFIG"
        echo "FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1" >> "$BOARDCONFIG"
        echo "OF_QUICK_BACKUP_WIPE := 1" >> "$BOARDCONFIG"
        echo "OF_USE_ASH := 1" >> "$BOARDCONFIG"
        echo "FOX_REPLACE_BUSYBOX_PS := 1" >> "$BOARDCONFIG"
        echo "OF_CRYPTPOLICY := 1" >> "$BOARDCONFIG"
        echo "FOX_AB_DEVICE := 0" >> "$BOARDCONFIG"
        echo "OF_SUPPORT_MIUI_JMIUI_BOOTMODE := 1" >> "$BOARDCONFIG"

    - name: Show NON-VANILLA Flags
      run: |
        echo "::group::âœ… 28 NON-VANILLA + TREBLE FLAGS INJECTED"
        tail -25 "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk"
        echo "::endgroup::"

    # ðŸ”¥ ENHANCED BUILD WITH DEBUG + FALLBACK
    - name: Building OrangeFox NON-VANILLA
      timeout-minutes: 90
      continue-on-error: false
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        
        echo "::group::ðŸ”§ ENVIRONMENT CHECK"
        java -version
        echo "JAVA_HOME: $JAVA_HOME"
        which java
        echo "::endgroup::"
        
        echo "::group::ðŸ”§ SOURCE & LUNCH OPTIONS"
        source build/envsetup.sh
        get_build_var | head -10 || true
        echo "::endgroup::"
        
        export ALLOW_MISSING_DEPENDENCIES=true
        export CCACHE_EXEC=/usr/bin/ccache
        export CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache
        
        echo "::group::ðŸ”§ LUNCH TARGETS"
        lunch | grep -E "(twrp_|omni_)${{ inputs.DEVICE_NAME }}" || echo "âš ï¸ No exact match, trying fallback..."
        echo "::endgroup::"
        
        # TRY MULTIPLE LUNCH OPTIONS
        LUNCH_SUCCESS=false
        for target in \
          "twrp_${{ inputs.DEVICE_NAME }}-eng" \
          "omni_${{ inputs.DEVICE_NAME }}-eng" \
          "${{ inputs.DEVICE_NAME }}-eng"; do
          echo "::group::ðŸ”„ Trying lunch: $target"
          if lunch "$target" 2>&1 | grep -q "done"; then
            echo "âœ… LUNCH SUCCESS: $target"
            LUNCH_SUCCESS=true
            break
          fi
          echo "âŒ $target failed"
        done
        
        if [ "$LUNCH_SUCCESS" = false ]; then
          echo "âŒ ALL LUNCH OPTIONS FAILED!"
          source build/envsetup.sh
          lunch
          exit 1
        fi
        echo "::endgroup::"
        
        echo "::group::ðŸ”§ MAKE CLEAN"
        make clean || make clobber || true
        echo "::endgroup::"
        
        echo "::group::ðŸš€ BUILDING ${{ inputs.BUILD_TARGET }}"
        time mka adbd ${{ inputs.BUILD_TARGET }}image || \
        time mka ${{ inputs.BUILD_TARGET }}image || \
        time mka ${{ inputs.BUILD_TARGET }}
        echo "::endgroup::"

    # ðŸ”¥ DEBUG ON FAILURE
    - name: Debug Build Failure
      if: failure()
      run: |
        echo "::group::ðŸ” FULL DEBUG LOGS"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        echo "=== WORKSPACE ==="
        pwd && ls -la
        echo "=== DEVICE TREE ==="
        ls -la ${{ inputs.DEVICE_PATH }}/
        cat ${{ inputs.DEVICE_PATH }}/AndroidProducts.mk || true
        echo "=== OUT DIR ==="
        find out/ -name "*.img" -o -name "*OrangeFox*" 2>/dev/null || true
        echo "=== LAST 100 LINES ==="
        tail -100 build.log out/*.log 2>/dev/null || true
        echo "::endgroup::"

    - name: Set Release Properties
      if: success()
      run: |
        echo "BUILD_DATE=$(TZ=Asia/Manila date +%Y%m%d)" >> $GITHUB_ENV
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
        if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
          DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
        fi
        echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV
        
        ORANGEFOX_IMG=$(find out/target/product/${{ inputs.DEVICE_NAME }} out -name "*OrangeFox*.img" -o -name "*recovery*.img" | head -1)
        if [[ -n "$ORANGEFOX_IMG" ]]; then
          echo "MD5_IMG=$(md5sum "$ORANGEFOX_IMG" | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "IMG_PATH=$(dirname "$ORANGEFOX_IMG")" >> $GITHUB_ENV
          echo "FOUND_IMG=$ORANGEFOX_IMG" >> $GITHUB_ENV
        else
          echo "NO_IMAGE_FOUND=true" >> $GITHUB_ENV
        fi

    # ðŸ”¥ IMAGE PROCESSING
    - name: Process Images
      if: env.MD5_IMG != ''
      run: |
        cd "${{ env.IMG_PATH }}"
        for img in OrangeFox*.img *recovery*.img *${{ inputs.BUILD_TARGET }}*.img; do
          if [[ -f "$img" ]]; then
            case "${{ inputs.BUILD_TARGET }}" in
              "boot") mv "$img" boot.img ;;
              "recovery") mv "$img" recovery.img ;;
              "vendorboot") mv "$img" vendor_boot.img ;;
            esac
            break
          fi
        done
        echo "RECOVERY_TYPE=$(echo ${{ inputs.BUILD_TARGET }} | sed 's/boot$/boot/;s/recovery$/recovery/;s/vendorboot$/vendor_boot/')" >> $GITHUB_ENV

    # ðŸ”¥ PACKAGING
    - name: Package Recovery Installer
      if: env.MD5_IMG != ''
      run: |
        cd "${{ env.IMG_PATH }}"
        wget -q https://github.com/kinguser981/recovery-installer/releases/download/11256427880/recovery-installer.zip
        zip -ur recovery-installer.zip ${{ env.RECOVERY_TYPE }}.img

    # ðŸ”¥ RELEASE
    - name: Upload to Release
      if: env.MD5_IMG != ''
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.IMG_PATH }}/*.img
          ${{ env.IMG_PATH }}/recovery-installer.zip
        name: OrangeFox NON-VANILLA [${{ inputs.DEVICE_NAME }}] - ${{ env.BUILD_DATE }}
        tag_name: ${{ github.run_id }}
        body: |
          ## ðŸ”¥ OrangeFox NON-VANILLA + TREBLE (28 FLAGS)
          **Device:** ${{ inputs.DEVICE_NAME }}
          **Branch:** fox_${{ inputs.MANIFEST_BRANCH }}
          **Target:** ${{ inputs.BUILD_TARGET }}
          **MD5:** `${{ env.MD5_IMG }}`
          **Commit:** [${{ env.COMMIT_ID }}](${{ env.DEVICE_TREE_URL }}/commit/${{ env.COMMIT_ID }})

    # ðŸ”¥ CLEANUP
    - name: Cleanup
      if: always()
      run: |
        rm -rf ${GITHUB_WORKSPACE}/OrangeFox scripts
        df -h
