# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox  
# https://github.com/azwhikaru for Recovery Builder Template
# https://github.com/TeamWin/android_build
# And all Contributors in every repositories I used

name: OrangeFox - Buildnvcrb

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options: [12.1, 11.0]
      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/nepntt8/Makeit2android_device_samsung_m14x.git'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: [boot, recovery, vendorboot]

jobs:
  build:
    name: Build OFR NON-VANILLA+TREBLE by ${{ github.actor }}
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Display Inputs
      run: |
        echo "::group::User Environment Variables"
        echo "Branch: ${{ inputs.MANIFEST_BRANCH }}"
        echo "Device: ${{ inputs.DEVICE_NAME }}"
        echo "Target: ${{ inputs.BUILD_TARGET }}"
        echo "::endgroup::"

    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24

    - name: Build Environment
      run: |
        echo "::group::ðŸ“¦ Installing Build Dependencies"
        sudo apt update && sudo apt install -y \
          aria2 bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg \
          gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool \
          libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync \
          schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip
        echo "::endgroup::"

    - name: Setup ccache
      run: |
        echo "::group::âš¡ Configuring ccache"
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        export CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache
        ccache -M 50G
        ccache -s
        echo "::endgroup::"

    - name: Clone Build Tools
      run: |
        echo "::group::ðŸ”§ Cloning Essential Build Tools"
        rm -rf scripts build_tools
        git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master scripts
        git clone https://github.com/TeamWin/android_build.git build_tools
        echo "::endgroup::"

    - name: Install repo tool
      run: |
        echo "::group::ðŸ“¦ Installing repo tool"
        mkdir -p ~/.bin
        PATH="${HOME}/.bin:${PATH}"
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+rx ~/.bin/repo
        echo 'export PATH="${HOME}/.bin:${PATH}"' >> ~/.bashrc
        source ~/.bashrc
        repo --version
        echo "::endgroup::"

    - name: Set-up Manifest
      if: contains(fromJSON('["11.0", "12.1"]'), inputs.MANIFEST_BRANCH)
      run: |
        echo "::group::ðŸ“¥ Syncing OrangeFox Sources"
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        git clone https://gitlab.com/OrangeFox/sync.git -b master
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        echo "::endgroup::"

    - name: Clone Device Tree
      run: |
        echo "::group::ðŸ“± Cloning Device Tree"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV
        echo "::endgroup::"

    # ðŸ”¥ DEVICE TREE VALIDATION
    - name: Validate Device Tree
      run: |
        echo "::group::ðŸ” DEVICE TREE VALIDATION"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}
        echo "ðŸ“ Required files check:"
        [[ -f BoardConfig.mk ]] && echo "âœ… BoardConfig.mk exists" || echo "âŒ BoardConfig.mk MISSING!"
        [[ -f AndroidProducts.mk ]] && echo "âœ… AndroidProducts.mk exists" || echo "âŒ AndroidProducts.mk MISSING!"
        [[ -f device.mk ]] && echo "âœ… device.mk exists" || echo "âŒ device.mk MISSING!"
        echo "ðŸ“‹ BoardConfig preview:"
        head -20 BoardConfig.mk || true
        echo "::endgroup::"

    # ðŸ”¥ 28 NON-VANILLA + TREBLE FLAGS (SAFER)
    - name: Inject NON-VANILLA+TREBLE Flags
      run: |
        echo "::group::âš™ï¸ Injecting NON-VANILLA Flags"
        BOARDCONFIG="${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk"
        [[ -f "$BOARDCONFIG" ]] || { echo "âŒ BoardConfig.mk not found!"; exit 1; }
        
        # Check if flags already exist (avoid duplicates)
        if ! grep -q "FOX_VANILLA_BUILD" "$BOARDCONFIG"; then
          echo "FOX_VANILLA_BUILD := 0" >> "$BOARDCONFIG"
        fi
        echo "OF_DISABLE_MIUI_SPECIFIC_FEATURES := 0" >> "$BOARDCONFIG"
        echo "OF_TREBLE_CHECK_ON_REBOOT := 1" >> "$BOARDCONFIG"
        echo "OF_SUPPORT_GSI_FLASHING := 1" >> "$BOARDCONFIG"
        echo "OF_KEEP_GSI_PARTIALLY_DECRYPTED := 1" >> "$BOARDCONFIG"
        echo "OF_GSI_MODE := 1" >> "$BOARDCONFIG"
        echo "OF_NO_TREBLE_COMPATIBILITY_CHECK := 0" >> "$BOARDCONFIG"
        echo "FOX_AVB := 1" >> "$BOARDCONFIG"
        echo "OF_PATCH_AVB20 := 1" >> "$BOARDCONFIG"
        echo "OF_USE_MAGISKBOOT := 1" >> "$BOARDCONFIG"
        echo "OF_USE_MAGISKBOOT_FOR_ALL_PATCHES := 1" >> "$BOARDCONFIG"
        echo "OF_DEFAULT_KEYMASTER_VERSION := 4.1" >> "$BOARDCONFIG"
        echo "FOX_USE_NANO_EDITOR := 1" >> "$BOARDCONFIG"
        echo "OF_USE_GREEN_LED := 1" >> "$BOARDCONFIG"
        echo "OF_FIX_7ZIP_ZIP := 1" >> "$BOARDCONFIG"
        echo "FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1" >> "$BOARDCONFIG"
        echo "OF_QUICK_BACKUP_WIPE := 1" >> "$BOARDCONFIG"
        echo "OF_USE_ASH := 1" >> "$BOARDCONFIG"
        echo "FOX_REPLACE_BUSYBOX_PS := 1" >> "$BOARDCONFIG"
        echo "OF_CRYPTPOLICY := 1" >> "$BOARDCONFIG"
        echo "FOX_AB_DEVICE := 0" >> "$BOARDCONFIG"
        echo "OF_SUPPORT_MIUI_JMIUI_BOOTMODE := 1" >> "$BOARDCONFIG"
        echo "::endgroup::"

    - name: Show NON-VANILLA Flags
      run: |
        echo "::group::âœ… 28 NON-VANILLA + TREBLE FLAGS INJECTED"
        tail -25 "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}/BoardConfig.mk"
        echo "::endgroup::"

    - name: Debug Build Environment
      run: |
        echo "::group::ðŸ” DEBUG: Build Environment Check"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        echo "ðŸ“ Build tree check:"
        ls -la build/make/core/main.mk || echo "âŒ main.mk MISSING!"
        ls -la build/envsetup.sh || echo "âŒ envsetup.sh MISSING!"
        find . -name "Android.mk" | head -5 || echo "âŒ No Android.mk files!"
        echo "ðŸ“‚ Device tree:"
        ls -la ${{ inputs.DEVICE_PATH }}/
        echo "::endgroup::"

    # ðŸ”¥ PROPER ANDROID BUILD SETUP
    - name: Building OrangeFox NON-VANILLA
      timeout-minutes: 120
      continue-on-error: false
      run: |
        echo "::group::ðŸš€ ORANGEFOX FULL BUILD (PROPER SETUP)"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        
        # ðŸ”¥ CRITICAL: Proper Android build environment setup
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        export CCACHE_DIR=${GITHUB_WORKSPACE}/.ccache
        ccache -M 50G
        
        echo "ðŸ“± Device: ${{ inputs.DEVICE_NAME }}"
        echo "ðŸ“ Path: ${{ inputs.DEVICE_PATH }}"
        echo "ðŸŽ¯ Target: ${{ inputs.BUILD_TARGET }}"
        
        echo "::group::ðŸ”§ ANDROID ENVIRONMENT SETUP"
        source build/envsetup.sh
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng 2>/dev/null || lunch ${{ inputs.DEVICE_NAME }}-eng
        echo "::endgroup::"
        
        echo "::group::ðŸ§¹ CLEAN BUILD"
        make clean && make clobber
        rm -rf out/ || true
        echo "::endgroup::"
        
        echo "::group::ðŸš€ MAIN BUILD"
        time mka bacon ${{ inputs.BUILD_TARGET }}image || \
        time mka ${{ inputs.BUILD_TARGET }}image || \
        time mka ${{ inputs.BUILD_TARGET }}
        echo "::endgroup::"
        
        echo "::group::ðŸ“¦ OUTPUT FILES"
        find out/ -name "*.img" -o -name "*OrangeFox*" 2>/dev/null || echo "âŒ No images found"
        ls -la out/target/product/${{ inputs.DEVICE_NAME }}/*.img 2>/dev/null || true
        echo "::endgroup::"

    - name: Set Release Properties
      if: success()
      run: |
        echo "BUILD_DATE=$(TZ=Asia/Manila date +%Y%m%d)" >> $GITHUB_ENV
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
        if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
          DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
        fi
        echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV
        
        ORANGEFOX_IMG=$(find out/target/product/${{ inputs.DEVICE_NAME }} out -name "*OrangeFox*.img" -o -name "*recovery*.img" | head -1)
        if [[ -n "$ORANGEFOX_IMG" ]]; then
          echo "MD5_IMG=$(md5sum "$ORANGEFOX_IMG" | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "IMG_PATH=$(dirname "$ORANGEFOX_IMG")" >> $GITHUB_ENV
          echo "FOUND_IMG=$ORANGEFOX_IMG" >> $GITHUB_ENV
        else
          echo "NO_IMAGE_FOUND=true" >> $GITHUB_ENV
        fi

    - name: Process Images
      if: env.MD5_IMG != ''
      run: |
        cd "${{ env.IMG_PATH }}"
        for img in OrangeFox*.img *recovery*.img *${{ inputs.BUILD_TARGET }}*.img; do
          if [[ -f "$img" ]]; then
            case "${{ inputs.BUILD_TARGET }}" in
              "boot") mv "$img" boot.img ;;
              "recovery") mv "$img" recovery.img ;;
              "vendorboot") mv "$img" vendor_boot.img ;;
            esac
            break
          fi
        done
        echo "RECOVERY_TYPE=$(echo ${{ inputs.BUILD_TARGET }} | sed 's/boot$/boot/;s/recovery$/recovery/;s/vendorboot$/vendor_boot/')" >> $GITHUB_ENV

    - name: Package Recovery Installer
      if: env.MD5_IMG != ''
      run: |
        cd "${{ env.IMG_PATH }}"
        wget -q https://github.com/kinguser981/recovery-installer/releases/download/11256427880/recovery-installer.zip
        zip -ur recovery-installer.zip ${{ env.RECOVERY_TYPE }}.img

    - name: Upload to Release
      if: env.MD5_IMG != ''
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.IMG_PATH }}/*.img
          ${{ env.IMG_PATH }}/recovery-installer.zip
        name: OrangeFox NON-VANILLA [${{ inputs.DEVICE_NAME }}] - ${{ env.BUILD_DATE }}
        tag_name: ${{ github.run_id }}
        body: |
          ## ðŸ”¥ OrangeFox NON-VANILLA + TREBLE (28 FLAGS)
          **Device:** ${{ inputs.DEVICE_NAME }}
          **Branch:** fox_${{ inputs.MANIFEST_BRANCH }}
          **Target:** ${{ inputs.BUILD_TARGET }}
          **MD5:** `${{ env.MD5_IMG }}`
          **Commit:** [${{ env.COMMIT_ID }}](${{ env.DEVICE_TREE_URL }}/commit/${{ env.COMMIT_ID }})

    - name: Cleanup
      if: always()
      run: |
        rm -rf ${GITHUB_WORKSPACE}/OrangeFox scripts build_tools
        df -h
