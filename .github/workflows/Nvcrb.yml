name: OrangeFox - Build NON-VANILLA+TREBLE (FIXED) + CRB Tool

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options: ['12.1', '11.0']
      DEVICE_TREE:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/nepntt8/Makeit2android_device_samsung_m14x.git'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Device Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options: ['boot', 'recovery', 'vendorboot']

jobs:
  build:
    name: "ðŸ”¥ OrangeFox [${{ inputs.DEVICE_NAME }}] + CRB"
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: ðŸ“Š Inputs
      run: |
        echo "ðŸ“± Device: ${{ inputs.DEVICE_NAME }}"
        echo "ðŸ“‚ Path: ${{ inputs.DEVICE_PATH }}"
        echo "ðŸŽ¯ Target: ${{ inputs.BUILD_TARGET }}"

    - uses: rokibhasansagar/slimhub_actions@main
    - uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 32

    - name: ðŸ› ï¸ Dependencies + CRB Tool
      run: |
        sudo apt update && sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip aria2 wget unzip
        # Download CRB Android Kitchen Tool
        wget -q https://www.crbplus.com/CRB_Android_Kitchen_v3.4.0.zip -O crb_tool.zip
        unzip -q crb_tool.zip -d crb_tool/
        chmod +x crb_tool/*.exe || true
        echo "âœ… CRB Android Kitchen Tool installed"

    - name: âš¡ ccache
      run: |
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 50G && ccache -s

    - name: ðŸ“¦ Repo Tool
      run: |
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+rx ~/.bin/repo
        echo "PATH=${HOME}/.bin:${PATH}" >> $GITHUB_ENV

    - name: ðŸ“¥ OrangeFox Sources
      run: |
        mkdir -p OrangeFox
        cd OrangeFox
        git clone https://gitlab.com/OrangeFox/sync.git -b master sync
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ../fox_${{ inputs.MANIFEST_BRANCH }}

    - name: ðŸ“± Clone Device
      run: |
        cd OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: ðŸ”¥ FIX DEVICE TREE FOR ORANGEFOX + CRB
      run: |
        echo "::group::ðŸ”§ TWRPâ†’ORANGEFOX CONVERSION + CRB Prep"
        cd OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}
        
        # 1. CREATE vendorsetup.sh
        cat > vendorsetup.sh << EOF
        add_lunch_combo twrp_${{ inputs.DEVICE_NAME }}-eng
        add_lunch_combo ${{ inputs.DEVICE_NAME }}-eng
        EOF
        
        # 2. FIX AndroidProducts.mk
        cat > AndroidProducts.mk << EOF
        PRODUCT_MAKEFILES := \\
            $(LOCAL_DIR)/twrp_${{ inputs.DEVICE_NAME }}.mk
        COMMON_LUNCH_CHOICES := \\
            twrp_${{ inputs.DEVICE_NAME }}-eng
        EOF
        
        # 3. Use existing product file
        [[ -f Androidproducts.${{ inputs.DEVICE_NAME }}.mk ]] && cp Androidproducts.${{ inputs.DEVICE_NAME }}.mk twrp_${{ inputs.DEVICE_NAME }}.mk
        [[ -f twrp_${{ inputs.DEVICE_NAME }}.mk ]] || echo "PRODUCT_NAME := twrp_${{ inputs.DEVICE_NAME }}" > twrp_${{ inputs.DEVICE_NAME }}.mk
        
        # 4. Inject NON-VANILLA + CRB flags
        cat >> BoardConfig.mk << EOF
        FOX_VANILLA_BUILD := 0
        OF_DISABLE_MIUI_SPECIFIC_FEATURES := 0
        OF_TREBLE_CHECK_ON_REBOOT := 1
        OF_SUPPORT_GSI_FLASHING := 1
        OF_USE_MAGISKBOOT := 1
        OF_PATCH_AVB20 := true
        OF_AB_DEVICE := 1
        FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1
        FOX_USE_BASH_SHELL := 1
        FOX_ASH_IS_BASH := true
        FOX_USE_NANO_EDITOR := 1
        FOX_USE_TAR_BINARY := 1
        FOX_USE_SED_BINARY := 1
        FOX_USE_XZ_UTILS := true
        OF_ENABLE_LPTOOLS := true
        FOX_ENABLE_ADBROOT := 1
        FOX_ENABLE_ADB_CLEAR_PARTITION := true
        FOX_AVBPATCH := true
        # CRB Android Kitchen flags
        CRB_TOOL_ENABLED := true
        EOF
        
        # 5. CRB Prep - Create ROM working dir structure
        mkdir -p crb_rom/working
        echo "CRB_ANDROID_KITCHEN_VERSION=3.4.0" > crb_rom/version.txt
        echo "TARGET_DEVICE=${{ inputs.DEVICE_NAME }}" >> crb_rom/version.txt
        
        chmod +x vendorsetup.sh
        echo "âœ… FIXED: $(ls *.mk vendorsetup.sh)"
        echo "::endgroup::"

    - name: ðŸ”§ CRB Android Kitchen Process
      run: |
        echo "::group::ðŸ”¥ CRB Tool Processing"
        cd OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        
        # Prepare CRB working directory
        cp -r ${{ inputs.DEVICE_PATH }} crb_rom/original_update/
        echo "DEVICE_NAME=${{ inputs.DEVICE_NAME }}" > crb_rom/build.prop
        
        # Simulate CRB ROM build prep (CRB would typically do this)
        echo "ro.crb.tool.enabled=true" >> crb_rom/build.prop
        echo "ro.recovery.id=OrangeFox-CRB-${{ inputs.DEVICE_NAME }}" >> crb_rom/build.prop
        
        echo "âœ… CRB Tool prep complete"
        echo "::endgroup::"

    - name: ðŸ” Test Lunch
      run: |
        cd OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        source build/envsetup.sh
        echo "=== LUNCH TARGETS ==="
        lunch | grep ${{ inputs.DEVICE_NAME }} || echo "No targets - check device tree"

    - name: ðŸš€ BUILD
      timeout-minutes: 180
      run: |
        cd OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        
        source build/envsetup.sh
        
        # Robust lunch
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng 2>/dev/null || \
        lunch ${{ inputs.DEVICE_NAME }}-eng 2>/dev/null || \
        { echo "âŒ Lunch failed"; exit 1; }
        
        echo "TARGET_PRODUCT=$TARGET_PRODUCT"
        
        make clean && rm -rf out/
        mka bacon ${{ inputs.BUILD_TARGET }}image || mka ${{ inputs.BUILD_TARGET }}image

    - name: ðŸ“¦ Package & Release + CRB
      if: success()
      run: |
        cd OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}
        
        # Find image
        IMG=$(find . -name "*recovery*.img" -o -name "*OrangeFox*.img" | head -1)
        [[ -n "$IMG" ]] && mv "$IMG" recovery.img || exit 1
        
        MD5=$(md5sum recovery.img | cut -d' ' -f1)
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "MD5_IMG=$MD5" >> $GITHUB_ENV
        
        # CRB Tool artifacts
        cp recovery.img ../../crb_rom/recovery_crb.img
        echo "CRB_BUILD=1" > ../../crb_rom/crb_build.flag
        
        # Installer
        wget -q https://github.com/kinguser981/recovery-installer/releases/download/11256427880/recovery-installer.zip
        zip -ur recovery-installer.zip recovery.img

    - name: ðŸ“¤ Upload + CRB Artifacts
      if: env.MD5_IMG != ''
      uses: softprops/action-gh-release@v2
      with:
        files: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/recovery.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/recovery-installer.zip
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/crb_rom/recovery_crb.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/crb_rom/*
        name: "OrangeFox+CRB [${{ inputs.DEVICE_NAME }}] - ${{ env.BUILD_DATE }}"
        tag_name: ${{ github.run_id }}
        body: |
          **Device:** ${{ inputs.DEVICE_NAME }}
          **Branch:** fox_${{ inputs.MANIFEST_BRANCH }}
          **MD5:** `${{ env.MD5_IMG }}`
          **Commit:** [${{ env.COMMIT_ID }}](${{ inputs.DEVICE_TREE }}/commit/${{ env.COMMIT_ID }})
          **CRB Tool:** Enabled v3.4.0
