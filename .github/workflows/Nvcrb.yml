name: OrangeFox - Build NON-VANILLA+TREBLE (FIXED)
# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox  
# https://github.com/azwhikaru for Recovery Builder Template
# And all Contributors in every repositories I used

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options:
        - 12.1
        - 11.0
      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/TeamWin/android_device_samsung_m14x'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot

jobs:
  build:
    name: "ðŸ”¥ OrangeFox [${{ inputs.DEVICE_NAME }}] by ${{ github.actor }}"
    runs-on: ubuntu-22.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
              
    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 32
      
    - name: ðŸ› ï¸ Dependencies (FIXED - No SDL1.2)
      run: |
        echo "::group::ðŸ› ï¸ Clean Dependencies"
        sudo apt update
        sudo apt clean && sudo apt autoclean && sudo apt autoremove -y
        
        sudo apt install -y --no-install-recommends \
          bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git gnupg gperf \
          imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5-dev \
          libssl-dev libxml2-utils lzop pngcrush \
          rsync schedtool squashfs-tools xsltproc \
          zip zlib1g-dev python3 python3-pip aria2 \
          wget unzip device-tree-compiler libelf-dev \
          git-lfs repo android-sdk-platform-tools-common
        
        sudo dpkg --add-architecture i386
        sudo apt update
        sudo apt install -y lib32gcc-s1 libc6-i386
        
        echo "âœ… Dependencies OK"
        echo "::endgroup::"

    - name: âš¡ ccache
      run: |
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 50G && ccache -s

    - name: ðŸ“¦ Setup Repo Tool
      run: |
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+rx ~/.bin/repo
        echo "PATH=${HOME}/.bin:${PATH}" >> $GITHUB_ENV

    - name: Set-up Manifest
      if: inputs.MANIFEST_BRANCH == '11.0' || inputs.MANIFEST_BRANCH == '12.1'
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        git clone https://gitlab.com/OrangeFox/sync.git -b master
        cd sync
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

    - name: ðŸ“± Clone Device Tree
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: ðŸ”¥ FIX DEVICE TREE FOR ORANGEFOX (COMPLETE)
      run: |
        echo "::group::ðŸ”§ Complete OrangeFox Device Prep"
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/${{ inputs.DEVICE_PATH }}
        
        DEVICE="${{ inputs.DEVICE_NAME }}"
        BOARDCONFIG="BoardConfig.mk"
        
        # 1. COMPLETE vendorsetup.sh
        echo "add_lunch_combo twrp_${DEVICE}-eng" > vendorsetup.sh
        echo "add_lunch_combo ${DEVICE}-eng" >> vendorsetup.sh
        chmod +x vendorsetup.sh
        
        # 2. COMPLETE AndroidProducts.mk
        echo "PRODUCT_MAKEFILES := \\" > AndroidProducts.mk
        echo "    $(LOCAL_DIR)/twrp_${DEVICE}.mk \\" >> AndroidProducts.mk
        echo "    $(LOCAL_DIR)/${DEVICE}.mk" >> AndroidProducts.mk
        echo "COMMON_LUNCH_CHOICES := \\" >> AndroidProducts.mk
        echo "    twrp_${DEVICE}-eng," >> AndroidProducts.mk
        echo "    ${DEVICE}-eng" >> AndroidProducts.mk
        
        # 3. COMPLETE twrp_${DEVICE}.mk
        cat > "twrp_${DEVICE}.mk" << EOF
        $(call inherit-product, $(SRC_TARGET_DIR)/product/embedded.mk)
        $(call inherit-product, $(SRC_TARGET_DIR)/product/full_base_telephony.mk)
        
        $(call inherit-product, device/samsung/m14x/${DEVICE}.mk)
        $(call inherit-product, vendor/omni/${DEVICE}/${DEVICE}-vendor.mk)
        
        PRODUCT_NAME := twrp_${DEVICE}
        PRODUCT_DEVICE := ${DEVICE}
        PRODUCT_BRAND := samsung
        PRODUCT_MODEL := Galaxy A14x
        PRODUCT_MANUFACTURER := samsung
        EOF
        
        # 4. BASE ${DEVICE}.mk
        cat > "${DEVICE}.mk" << EOF
        $(call inherit-product, $(SRC_TARGET_DIR)/product/core_64_bit.mk)
        $(call inherit-product, $(SRC_TARGET_DIR)/product/full_base_telephony.mk)
        
        PRODUCT_DEVICE := ${DEVICE}
        PRODUCT_NAME := ${DEVICE}
        PRODUCT_BRAND := samsung
        PRODUCT_MODEL := Galaxy A14x
        PRODUCT_MANUFACTURER := samsung
        
        $(call inherit-product, $(SRC_TARGET_DIR)/product/aosp_ab_device.mk)
        EOF
        
        # ðŸ”¥ ORANGEFOX FLAGS (ECHO STYLE - ORGANIZED)
        echo "# ðŸ”¥ ORANGEFOX CORE FLAGS" >> "$BOARDCONFIG"
        echo "FOX_VANILLA_BUILD := 0" >> "$BOARDCONFIG"
        echo "FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER := 1" >> "$BOARDCONFIG"
        echo "FOX_USE_BASH_SHELL := 1" >> "$BOARDCONFIG"
        echo "FOX_ASH_IS_BASH := true" >> "$BOARDCONFIG"
        echo "FOX_USE_NANO_EDITOR := 1" >> "$BOARDCONFIG"
        echo "FOX_USE_TAR_BINARY := 1" >> "$BOARDCONFIG"
        echo "FOX_USE_SED_BINARY := 1" >> "$BOARDCONFIG"
        echo "FOX_USE_XZ_UTILS := true" >> "$BOARDCONFIG"
        
        echo "" >> "$BOARDCONFIG"
        echo "# ðŸŒ TREBLE/GSI SUPPORT" >> "$BOARDCONFIG"
        echo "OF_TREBLE_CHECK_ON_REBOOT := 1" >> "$BOARDCONFIG"
        echo "OF_SUPPORT_GSI_FLASHING := 1" >> "$BOARDCONFIG"
        echo "OF_KEEP_GSI_PARTIALLY_DECRYPTED := 1" >> "$BOARDCONFIG"
        echo "OF_GSI_MODE := 1" >> "$BOARDCONFIG"
        echo "OF_NO_TREBLE_COMPATIBILITY_CHECK := 0" >> "$BOARDCONFIG"
        
        echo "" >> "$BOARDCONFIG"
        echo "# ðŸ”¥ AVB2.0 + MAGISKBOOT" >> "$BOARDCONFIG"
        echo "OF_USE_MAGISKBOOT := 1" >> "$BOARDCONFIG"
        echo "OF_PATCH_AVB20 := 1" >> "$BOARDCONFIG"
        echo "OF_AB_DEVICE := 1" >> "$BOARDCONFIG"
        echo "FOX_AVBPATCH := true" >> "$BOARDCONFIG"
        
        echo "" >> "$BOARDCONFIG"
        echo "# âš™ï¸ ADVANCED FEATURES" >> "$BOARDCONFIG"
        echo "OF_DISABLE_MIUI_SPECIFIC_FEATURES := 1" >> "$BOARDCONFIG"
        echo "OF_ENABLE_LPTOOLS := true" >> "$BOARDCONFIG"
        echo "FOX_ENABLE_ADBROOT := 1" >> "$BOARDCONFIG"
        echo "FOX_ENABLE_ADB_CLEAR_PARTITION := true" >> "$BOARDCONFIG"
        
        echo "" >> "$BOARDCONFIG"
        echo "# ðŸ“± TWRP EXTRAS" >> "$BOARDCONFIG"
        echo "TW_USE_FUSE_EXFAT := true" >> "$BOARDCONFIG"
        echo "BOARD_HAS_NO_SELECT_BUTTON := true" >> "$BOARDCONFIG"
        echo "TW_DEVICE_VERSION := 12.1" >> "$BOARDCONFIG"
        
        echo "âœ… Device tree FIXED with 5 flag groups!"
        ls -la *.mk vendorsetup.sh
        echo "::endgroup::"

    - name: ðŸ” Validate Lunch Targets
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        source build/envsetup.sh
        echo "=== ALL TARGETS ==="
        lunch 2>&1 | head -15
        echo "=== DEVICE TARGETS ==="
        lunch 2>&1 | grep -i "${{ inputs.DEVICE_NAME }}"

    - name: Building OrangeFox
      timeout-minutes: 240
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        
        source build/envsetup.sh
        
        # Robust lunch
        LUNCH_SUCCESS=false
        for target in "twrp_${{ inputs.DEVICE_NAME }}-eng" "${{ inputs.DEVICE_NAME }}-eng"; do
          if lunch "$target" 2>/dev/null; then
            echo "âœ… Lunch: $target"
            LUNCH_SUCCESS=true
            break
          fi
        done
        
        [[ "$LUNCH_SUCCESS" == "false" ]] && { echo "âŒ Lunch failed"; exit 1; }
        
        make clean
        mka adbd ${{ inputs.BUILD_TARGET }}image

    - name: Set Release Properties
      if: success()
      run: |
        echo "BUILD_DATE=$(TZ=Asia/Manila date +%Y%m%d-%H%M)" >> $GITHUB_ENV
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
        if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
          DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
        fi
        echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV
        
        cd out/target/product/${{ inputs.DEVICE_NAME }}
        MD5=$(md5sum *.img | cut -d' ' -f1 | head -1)
        SHA256=$(sha256sum *.img | cut -d' ' -f1 | head -1)
        echo "MD5_IMG=$MD5" >> $GITHUB_ENV
        echo "SHA256_IMG=$SHA256" >> $GITHUB_ENV

    - name: Upload to Release
      if: success() && env.MD5_IMG != ''
      uses: softprops/action-gh-release@v2
      with:
        files: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
        name: "OrangeFox [${{ inputs.DEVICE_NAME }}] ${{ env.BUILD_DATE }}"
        tag_name: ${{ github.run_id }}
        body: |
          ## ðŸ”¥ OrangeFox Recovery Build - Unofficial
          
          **Device**: `${{ inputs.DEVICE_NAME }}`
          **Build**: `${{ env.BUILD_DATE }}`
          **Branch**: `fox_${{ inputs.MANIFEST_BRANCH }}`
          **MD5**: `${{ env.MD5_IMG }}`
          **SHA256**: `${{ env.SHA256_IMG }}`
          
          **Device Tree**: [${{ inputs.DEVICE_TREE_BRANCH }}](${{ env.DEVICE_TREE_URL }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          **
